<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è ¬´–ï—Å—Ç—å –†–µ—à–µ–Ω–∏–µ¬ª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #f9f9f9;
      color: #333;
    }

    header {
      background-color: #003366;
      padding: 20px;
      color: white;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 26px;
    }

    .hero {
      background: url('https://i.imgur.com/rlOdb3u.png') no-repeat right bottom;
      background-size: contain;
      background-color: #e3f2fd;
      padding: 60px 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .hero h2 {
      font-size: 28px;
      margin: 0 0 10px 0;
      color: #003366;
    }

    .hero p {
      font-size: 18px;
      max-width: 600px;
    }

    .section {
      padding: 40px 20px;
      max-width: 1000px;
      margin: auto;
    }

    .section h3 {
      color: #003366;
    }

    footer {
      background-color: #003366;
      color: white;
      text-align: center;
      padding: 20px;
    }

    #mic-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      width: 60px;
      height: 60px;
      background: url('https://i.imgur.com/MxjPNdW.png') no-repeat center;
      background-size: 70%;
      border: none;
      border-radius: 50%;
      background-color: #007bff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      cursor: pointer;
    }

    #voice-indicator {
      position: fixed;
      bottom: 95px;
      right: 34px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: limegreen;
      animation: pulse 1s infinite ease-in-out;
      display: none;
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.5); opacity: 0.5; }
      100% { transform: scale(1); opacity: 1; }
    }

    #status, #output, #audio-player {
      display: none;
    }

    @media (max-width: 600px) {
      .hero {
        padding: 40px 20px;
        background-position: center bottom;
        background-size: cover;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è ¬´–ï—Å—Ç—å –†–µ—à–µ–Ω–∏–µ¬ª</h1>
</header>

<section class="hero">
  <h2>–°–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–≥–æ–≤ —á–µ—Ä–µ–∑ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–æ</h2>
  <p>–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è, –±—ã—Å—Ç—Ä–∞—è –ø–æ–¥–∞—á–∞, –±–µ–∑ —Å—Ç—Ä–µ—Å—Å–∞. –ù–∞—à –≥–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.</p>
</section>

<section class="section">
  <h3>–ü–æ—á–µ–º—É –≤—ã–±–∏—Ä–∞—é—Ç –Ω–∞—Å</h3>
  <ul>
    <li>‚úÖ –û–ø—ã—Ç –±–æ–ª–µ–µ 7 –ª–µ—Ç</li>
    <li>‚úÖ –†–∞–±–æ—Ç–∞–µ–º –ø–æ –≤—Å–µ–π –†–æ—Å—Å–∏–∏</li>
    <li>‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —é—Ä–∏—Å—Ç –∏ –ø–æ–ª–Ω–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ</li>
  </ul>
</section>

<section class="section">
  <h3>–û—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
  <p>‚Äú–û—á–µ–Ω—å –ø–æ–º–æ–≥–ª–∏. –í—Å—ë —Ä–∞—Å—Å–∫–∞–∑–∞–ª–∏ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã. –°–ø–∞—Å–∏–±–æ –∫–æ–º–∞–Ω–¥–µ!‚Äù ‚Äì –ê–Ω–∞—Å—Ç–∞—Å–∏—è, –ß–µ–ª—è–±–∏–Ω—Å–∫</p>
</section>

<footer>
  <p>&copy; 2025 –Æ–ö ¬´–ï—Å—Ç—å –†–µ—à–µ–Ω–∏–µ¬ª</p>
</footer>

<button id="mic-btn"></button>
<div id="voice-indicator"></div>
<div id="status"></div>
<div id="output"></div>
<audio id="audio-player" autoplay></audio>

<script>
  const OPENAI_PROXY_URL = "https://openai-gpt-proxy.onrender.com/gpt";
  const STREAM_URL = "https://elevenlabs-render-proxy.onrender.com/stream";

  let messages = [];
  let isRunning = false;

  async function recognizeSpeech(timeout = 10000) {
    return new Promise((resolve, reject) => {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) return reject("SpeechRecognition –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");

      const recognition = new SpeechRecognition();
      recognition.lang = "ru-RU";
      recognition.interimResults = false;

      const timer = setTimeout(() => {
        recognition.stop();
        reject("‚è±Ô∏è –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ");
      }, timeout);

      recognition.onresult = (event) => {
        clearTimeout(timer);
        recognition.stop();
        const text = event.results[0][0].transcript;
        resolve(text);
      };
      recognition.onerror = (err) => {
        clearTimeout(timer);
        recognition.stop();
        reject(err.error || "–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è");
      };

      recognition.start();
    });
  }

  async function askGPT() {
    const res = await fetch(OPENAI_PROXY_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages: messages.slice(-10) })
    });
    const data = await res.json();
    return data.choices?.[0]?.message?.content || "‚ùå GPT –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª";
  }

  async function playTTS(text) {
    const indicator = document.getElementById("voice-indicator");
    indicator.style.display = "block";

    const res = await fetch(STREAM_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text })
    });

    if (!res.ok) {
      console.warn("üõë Fetch error:", await res.text());
      indicator.style.display = "none";
      return;
    }

    const audioBlob = new Blob([await res.arrayBuffer()], { type: "audio/mpeg" });
    if (audioBlob.size < 1000) {
      indicator.style.display = "none";
      return;
    }

    const audioUrl = URL.createObjectURL(audioBlob);
    const audio = document.getElementById("audio-player");
    audio.src = audioUrl;
    audio.load();

    try {
      await audio.play();
    } catch (err) {
      console.warn("üéß autoplay error:", err);
    }

    await new Promise(resolve => {
      audio.onended = resolve;
      audio.onerror = resolve;
    });

    indicator.style.display = "none";
  }

  async function dialogLoop() {
    if (isRunning) return;
    isRunning = true;

    try {
      while (true) {
        await new Promise(r => setTimeout(r, 600));

        const userText = await recognizeSpeech();
        messages.push({ role: "user", content: userText });

        const reply = await askGPT();
        messages.push({ role: "assistant", content: reply });

        await playTTS(reply);
      }
    } catch (err) {
      console.warn("üí• –û—à–∏–±–∫–∞:", err);
    } finally {
      isRunning = false;
    }
  }

  document.getElementById("mic-btn").onclick = () => {
    dialogLoop();
  };

  window.addEventListener("load", () => {
    // –ü—Ä–æ–≥—Ä–µ–≤
    try {
      const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (Recognition) {
        const warmup = new Recognition();
        warmup.lang = "ru-RU";
        warmup.onstart = () => warmup.abort();
        warmup.start();
      }
    } catch (e) {
      console.warn("üßä STT warmup fail:", e);
    }

    fetch(OPENAI_PROXY_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages: [{ role: "user", content: "ping" }] })
    });

    fetch(STREAM_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: "–¢–µ—Å—Ç" })
    });
  });
</script>

</body>
</html>
